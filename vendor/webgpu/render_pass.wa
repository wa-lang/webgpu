
import "js"

type Color struct {
    R, G, B, A: f32
}

type LoadOp u32

const (
    LoadOp_clear = iota
    LoadOp_load
)

global loadOpSymbols = [...]string {
    LoadOp_clear: "clear",
    LoadOp_load:  "load",
}

type StoreOp u32

const (
    StoreOp_store = iota
    StoreOp_discard
)

global storeOpSymbols = [...]string {
    StoreOp_store:   "store",
    StoreOp_discard: "discard",
}

type RenderPassDesc_ColorAttchment struct {
    ClearValue: Color
    LoadOp: LoadOp
    StoreOp: StoreOp
    View: TextureView
}

/*
不能使用该类型直接声明值，需通过 NewRenderPassDesc() 创建
该对象需每帧重建
*/
type RenderPassDesc struct {
    js.ExtObj
}

func NewRenderPassDesc() => RenderPassDesc {
    rpd: RenderPassDesc
    rpd.ExtObj = js.NewExtObj()

    return rpd
}

func RenderPassDesc.SetColorAttachments(attachments: []RenderPassDesc_ColorAttchment) {
    va := js.NewExtArray()
    for _, a := range attachments {
        vo := js.NewExtObj()

        {
            vc := js.NewExtObj()
            vc.SetMember_f32("r", a.ClearValue.R)
            vc.SetMember_f32("g", a.ClearValue.G)
            vc.SetMember_f32("b", a.ClearValue.B)
            vc.SetMember_f32("a", a.ClearValue.A)
            vo.SetMember_obj("clearValue", vc)
        }

        vo.SetMember_string("loadOp", loadOpSymbols[a.LoadOp])
        vo.SetMember_string("storeOp", storeOpSymbols[a.StoreOp])
        vo.SetMember_obj("view", a.View.ExtObj)

        va.Append_obj(vo)
    }

    this.SetMember_obj("colorAttachments", va.ExtObj)
}

/*
不能使用该类型直接声明值，需通过 CommandEncoder.BeginRenderPass() 创建
该对象需每帧重建
*/
type RenderPass struct {
    js.ExtObj
}

func RenderPass.SetPipeline(p: RenderPipeline) {
    jsSetRenderPassPipeline(this.GetHandle(), p.GetHandle())
}

func RenderPass.SetVertexBuffer(slot: i32, vb: Buffer) {
    jsSetRenderPassVertexBuffer(this.GetHandle(), slot, vb.GetHandle())
}

func RenderPass.Draw(vertex_count: i32) {
    jsDrawRenderPass(this.GetHandle(), vertex_count)
}

func RenderPass.End() {
    jsEndRenderPass(this.GetHandle())
}

/*
不能使用该类型直接声明值，需通过 Device.CreateCommandEncoder() 创建
该对象需每帧重建
*/
type CommandEncoder struct {
    js.ExtObj
}

func CommandEncoder.BeginRenderPass(desc: RenderPassDesc) => RenderPass {
    rp: RenderPass
    rp.ExtObj = js.WrapExtObj(jsBeginRenderPass(this.GetHandle(), desc.GetHandle()))

    return rp
}

func CommandEncoder.Finish() => GPUCommandBuffer {
    gb: GPUCommandBuffer
    gb.ExtObj = js.WrapExtObj(jsFinishCommandEncoder(this.GetHandle()))

    return gb
}

/*
不能使用该类型直接声明值，需通过 CommandEncoder.Finish() 等创建
该对象需每帧重建
*/
type GPUCommandBuffer struct {
    js.ExtObj
}